# イベント名札を電子化する本

## まえがき

## ESP32

中国Espressif社が開発したWi-Fi/Bluetooth内蔵の32bitマイコンで、非常に安価なことから2010年代後半以降の電子工作で多用される。

外付けFlashとアンテナを組み込んだモジュールが市場に出回っており、日本国内でも工事設計認証 (技適) 取得済みのものが数百円で入手できる。

- CPU: Xtensa LX6 (32bit/160MHz 1コアまたは240MHz 2コア)
- SRAM: 520KB
- Flash: 4/8/16MB (外付け)
- 外付けPSRAM対応
- 2.4GHz 無線
  - IEEE 802.11 b/g/n
  - Bluetooth BR/EDR + Bluetooth Low Energy
- 駆動電圧: 3.3V

![ESP32 アーキテクチャ](images/esp32-architecture.png)

Espressifからはチップに加え、周辺部品を組み込み済のモジュールが発売されている。
代表的な製品は2コア版である次の2種類。
価格差が少ないことから1コア版はあまり使われない。

- ESP32-D0WD: 基本となるチップ。現在は改良版のESP32-D0WD-V3が発売
  - ESP32-WROOM-32: 外付けFlashと水晶振動子を内蔵し、アンテナ (または端子) を備えたモジュール
  - ESP32-WROVER: ESP32-WROOMに加え、PSRAMを内蔵したモジュール
- ESP32-PICO-D4: 外付けFlashと水晶振動子を内蔵したSiP (Silicon in Package)

Webサイトにはドキュメント (英語/中国語) が数多く公開されている。
本書はデータシートを参照して執筆しているが、改訂の頻度も高いので各自で最新の資料を参照されたし。

### ペリフェラル

直訳では**周辺機器**だが、マイコンの世界では内蔵の入出力機能のことをいう。

#### GPIO (General-Purpose Input/Output)

マイコンの最も基本的なペリフェラルで、HIGH/LOWのデジタル入出力を行う機能。
ESP32ではGPIO0～19, 21～23, 25～27, 32～39の34本を備える。
GPIO34～39は入力専用で、それ以外は入出力どちらにも対応しており内蔵プルアップ/プルダウン抵抗も使用できる。

各GPIOあたり20mA (ESP-IDFでは5, 10, 20, 30mAから変更可能) 、各Power Domainあたり合計で40mAまでドライブすることが可能。
したがってLEDを点灯させる程度であればGPIOの電流でも事足りる。

いくつかのGPIOは起動モード選択用に使用されており、**GPIO0をLOWで、かつGPIO2をLOWにして**起動するとプログラム書き込みモードで起動する。
GPIO12をHIGHにして起動するとFlashに1.8Vが供給され、通常組み込まれる3.3V駆動のFlashは動作できず起動できない。
この3つのGPIOは何も繋がずオープンにしておくのが無難。
またGPIO34～39は入力専用である。

後述のI2C, SPI, UARTなどのペリフェラルはGPIOマトリクスを経由してGPIOピンへ接続されているため、どのGPIOピンにも割り当てることができる。

#### I2C (Inter-Integrated Circuit)

SCL (シリアルクロック) と SDA (シリアルデータ) の2本の信号線で半二重通信を実現する規格。
通信速度は100～400kbpsと遅く配線も長くするのには向かないので、主に基板上のチップ間の接続に用いられる。

なんといっても信号線の少なさが利点であり、7bitのアドレスでスレーブを識別することから1つのマスターに対し複数のスレーブを接続することができる (アドレスが被るスレーブは同一系統に接続できない)。
SCLとSDAは共にプルアップしておく必要がある。
ESP32では `I2C0`, `I2C1` の2系統を持つ。

名称から、I2Cの「2」は上付きで表記する。
「アイツーシー」と読まれることも多いが、**「アイスクエアドシー」が正確な読み**である。

#### SPI (Serial Peripheral Interface)

SCL (シリアルクロック), MISO (マスターイン/スレーブアウト), MOSI (マスターアウト/スレーブイン), SS (スレーブセレクト、CS (チップセレクト) とも) の4本の信号線を用いた全二重通信が可能な規格。
I2C同様基板上のチップ間での通信に用いられる規格だが、こちらは1～2Mbpsの速度が出せる。
あのSDカードもSPIのインターフェースを備えている。

1つのマスターからSCL, MISO, MOSIは複数のスレーブに接続可能だが、SSはスレーブの数だけ別々に接続する。
SSのHIGH/LOWで通信相手を識別するので、I2Cのアドレス指定のような動作は必要ない。

ESP32は `SPI`, `HSPI`, `VSPI` の3系統のSPIを持っている。
`SPI` は外付けFlash (とPSRAM) の接続に使用しており、他の用途には使用できない。

#### UART (Universal Asynchronous Receiver/Transmitter)

単に**シリアル通信**と呼ばれるものの一種で、RX (受信) TX (送信) の2本の通信線で通信する。
PCの世界では同様の通信方式がRS-232Cにて使用されてきた (RS-232C = UARTではない。論理レベルや論理値が異なる)。

フロー制御用の信号としてDTR, RTSも用意されているが使用しなくても動作する。
クロック信号を使った同期を取らず誤り検出の機能も持たない (ソフトウェア上で対応することはできる) ので、受信データが化けたり欠落することもある。
通信速度は9600bps～115.2kbpsが多く使われているが、ハードウェアが速度に追い付くのであればそれ以上でも通信できる。

仕組みが簡単なこともあってマイコンには今でも当たり前のように搭載されているが (USBが使えるマイコンも勿論存在するが、規格が複雑で制御はかなり難しくなる)、PCでは使われなくなってきて久しく (PCでも機器の設定や制御を行う用途ではまだ現役で、産業用途で多用される)、**USBシリアル変換IC**を介して接続することがほとんどである (このUSBシリアル変換ICがまた癖のあるもので、FT232が最も安定するものの比較的高価。次点でCP210xで、その他CH340、PL2303など。偽物が出回っている、モジュールの設計ミスで3.3V出力に高い電圧が出る、ドライバが不安定、Windows 10用のドライバが無い製品がまだ出回っている、Webサイトが中国語のみ、など中々混沌としている)。
ESP32では `UART0`, `UART1`, `UART2` の3系統を備える。

#### ADC (Analog-Digital Conveter)

アナログ電圧入力を一定範囲の値へ変換する。
ESP32では分解能12bit (0～4095) のADCを2系統合わせて18ch (8ch + 10ch) 備える。
使用できるGPIOピンは固定されている。

#### DAC (Digital-Analog Converter)

ADCとは逆の役割で、一定範囲の値からアナログ電圧出力へ変換する。
音声出力などの用途で使用される。

ESP32では8bit (0～255) 出力のDACを2ch備え、GPIO25, GPIO26で使用できる。

#### PWM (Pulse Width Modulation)

日本語では**パルス幅変調**といい、任意の周波数とデューティ比 (HIGHを出力する時間の比率) でHIGH/LOW出力を切り替える機能。
HIGHの電圧を出力しながらもデューティ比の変更で平均電圧を制御できるので、動作に一定以上の電圧を求められる (=DACで出力した電圧では動かせない) モータの速度やLEDの明るさ制御などで使用される。

ESP32では16chのPWM出力を持ち、デューティ比は0 (0%) ～ 256 (100%) の範囲で設定する。
周波数の分解能は16bitで、ベースクロックが80MHzなので `80 [kMz] / 2 ^ 16 [bit] = 1.2207 [kHz]` まで下げられる。

### Wi-Fi

ESP32では2.4GHz帯のIEEE 802.11b/g/nに対応する。

### Bluetooth

レジ本から抜粋

## M5Stack

中国M5Stack社が発売しているマイコンボードで、ESP32に予め周辺部品を接続してプラスチック製ケースに収めているのが特徴。
電子工作でありがちなハードウェア回りの設計と調達で悩む必要がなく、買ってきたままの構成でプログラムを書くだけでIoTプロトタイピングを始められ、丈夫なケースに入っているのでそのまま実運用に持っていくことができる。

製品化のペースが非常に早く、毎週のように新商品が発売されている。
ロット変更で公式Webサイトでの予告なしに仕様変更が入ることもあるが、元々ESP32は日本での人気が高く、M5Stackも早期から日本市場との交流を続けてきたので個人ブログやTwitterなどでの日本語の情報も比較的多い。

### 本体

Core、Module、Bottomの三層構造になっており、CoreとBottomの間にModuleを重ねる (Stack) と電気的にも接続される構造をとっている。
このおかげで半田付けもブレッドボードも不要で機能を拡張できる。

- Core: MCU、LCD、周辺部品などがケースに収められたモジュール。
  - 最低限必要な部品は全てCoreに収まっているので、ModuleやBottomがなくても動作はする。
- Module: 電源、通信などの機能を収めたモジュール。
  - ユニバーサル基板が付いたProto Moduleが販売されており、自作の回路をModule化することもできる。
- Bottom: LiPoバッテリが収められた底面モジュール。

本体はCore + Bottomのセットで販売されている。
どれを買ったら良い? というと甲乙付けがたいが、単体であれこれするならCore2、電子部品と繋いでいじるならBasicとの価格差も少ないGrayではないだろうか (結局あとから買い増しして揃うのがM5Stack沼である)。

#### Basic/Gray/Fire

初期からある本体。
周辺部品の違いで3種類用意されている。
半導体不足の影響でUSBシリアル変換ICが変更されたものはリビジョンが変わっている (それ以前もIMUやLCDなどが変更されているが、品番も変わらず予告もなかった)。

比較的価格が安く、他の電子部品と接続しやすいなど後発のCore2と棲み分けがなされており、執筆時点に至るまで併売されている。

- Basic: 基本的な製品。
  - 150mAhのLiPoバッテリが装着されたBattery Bottomが装着されている。M-BUSの配線がピンヘッダ/ピンソケットが引き出されており、付属のジャンパワイヤでブレッドボード等と接続できる。
- Gray: BasicにIMU (BMM150 + MPU6886) が加えられた上位版。
- Fire: Grayに加えてMCUにPSRAMが接続されている。Grove B/CポートとNeoPixel付きのM5GO Bottomが装着されている。

![M5Stack Basic/Gray/Core](images/m5stack-connection.png)

#### Core2

全面的に刷新された本体で、MCUはFireと同様にPSRAMが接続されている。
外部接続端子はM-BUSとGrove互換ポートのみで、内蔵部品やGroveモジュールを動かす用途に向く。
M-BUSにはIMU (BMM150 + MPU6886) とマイクが搭載された子基板が装着済み。

LiPoバッテリは390mAhへ増量しており、Coreの底面と面一になる専用のBottomが付属する。

Grove互換ポートが `GPIO32`/`GPIO33` へ変更されており、I2C以外にGPIOなど各種ペリフェラルを割り当てて使用できるようになっている。
このためI2Cを使用する際は `GPIO21`/`GPIO21` へ割り当てられた `I2C` とは別系統になり、`I2C1` を割り当てる。

緑色LEDと振動モータは電源管理IC AXP192を経由で接続されている。
これらはAXP192のAPIを使用して制御できる。

![M5Stack Core2](images/m5stack-core2-connection.png)

### 入手先

#### 国内

- スイッチサイエンス
  - 日本国内での総代理店。
  - 千石電商、マルツパーツ館、共立電子など、スイッチサイエンス製品の取り扱いがある電子部品店では実店舗での購入も可能。
- 秋月電子通商
  - 並行輸入品扱いで一部商品の取り扱いがある。

Amazonなどの大手通販サイトでも出品がみられるが、正規ルートではないので購入は自己責任。

#### 個人輸入

決済、配送事故などのトラブルがあっても自力での交渉が求められる。
購入は自己責任で。

- M5Stack社 直販
  - m5stack-store
  - AliExpress M5Stack Official Store
- 正規代理店
  - DigiKey
  - Mouser

M5Stack社の直販窓口で購入すると中国から発送される。
直販サイトは外国人向けの窓口なので中国語スキルは必要なく、何かあっても翻訳サービスを使って英文のメールが読み書きできれば最低限の対応はできる。
配送方法はいくつかの選択肢から選ぶことができる。
輸送規制の厳しいリチウムイオン電池を含むのもあってか、送料が安価なeパケット (国際書留) を利用するとシンガポール経由となるようで、3～4週間を要する。
送料が高額な国際宅配便のDHLを利用するとさすがに早く、1週間前後で届く。

AliExpressなどでは他の業者も出品しているが、やはり正規ルートではないので自己責任となる。

DigiKeyとMouserは極めて多品種の電子部品を取り扱う通販業者で、かつメーカー公認で正規品を確実に入手できる。
日本向けの窓口があるので、日本語のメールで相談を受けてもらえる。
全てアメリカからの発送 (このためか輸出規制が厳しく、購入時に用途を聞かれる。注文内容によっては審査が入り、発送が遅れることもある) となるものの (競合他社のRSコンポーネンツは日本にも倉庫がある。ただしM5Stackの取り扱いはない)、国際宅配便を利用することから4日前後と非常に早く届く反面送料が高額。
マルツではDigiKey商品の取り寄せが可能なので、送料無料 (DigiKeyで6000円) に届かないときはマルツ経由で注文する方が安く済む。

### ペリフェラル

#### GPIO

M5Stackでは内蔵部品と外部入出力へ多くのGPIOが予め割り当てられており、自由に使えるGPIOは多くない。
自由に使用できるGPIOをリストアップする。

|GPIO|使用可否|備考|
|--:|:--:|:--|
|5|○||
|13|○||
|15|△|M5GO Bottom内蔵のNeoPixelが使用|
|16|△|PSRAMを使用していなければOK|
|17|△|PSRAMを使用していなければOK|
|26|○||
|35|△|入力専用|
|36|△|入力専用|

Core2では回路とM-BUSのピンアサインが変更されており、使えるGPIOが異なる。

|GPIO|使用可否|備考|
|--:|:--:|:--|
|13|○||
|14|○||
|19|○||
|25|△|M5GO Bottom2内蔵のNeoPixelが使用|
|27|○||
|32|△|Grove互換ポートと接続|
|33|△|Grove互換ポートと接続|
|35|△|入力専用|
|36|△|入力専用|

#### I2C

`I2C0` を周辺チップとの接続のほか、Grove互換ポートとも共有している。
Core2ではGrove互換ポートのピン配置が変更され、I2C以外でも使用できるようになった。

#### SPI

`VSPI` をLCDとSDカードへの接続に使用している。

#### UART

`UART0` がUSBシリアル変換IC (CP2104またはCH9102) と接続された状態で設定済で、USBで接続したPCと送受信できる。
`UART1`, `UART2` はRX, TXを自分で割り当ててから使用する。

#### M-BUS

![M-BUS](images/m-bus.png)

背面にはM5Stack独自のM-BUSが引き出されている。

Basic/Gray/FireとCore2ではピンアサインが異なり、**太字**で示したピンが変更されている。
概ね互換性が考慮されているが、Core2では `PA_SDA` と `PA_SCL` (Grove互換ポートと接続) が増え、`GPIO` の配置がずれている。
その分I2Sのピン数が減っている。

## 環境構築

### ESP32 Arduino

![Arduino フレームワーク](images/arduino-framework.png)

Atmel (現: Microchip) AVR等のマイコンボードである**Arduino**での開発環境をAPI互換でESP32へ移植したもので、開発元のEspressif自らメンテナンスしており、利用者も多い。

Arduino IDEへインストールして使用する設計で、Arduinoの開発経験があれば違和感なく使用できる。
一方でTimerなど一部のAPIは非互換で別個に用意されている。
後述のESP-IDFの上で動作しており、足りない機能があってもESP-IDFのAPIをそのまま呼び出して使用できる。

プログラミング言語は、公式には**Arduino言語**と称している。
実体はC++そのもので、`.ino` 形式の**スケッチ** (Arduinoではプログラムをこう呼ぶ) にArduino標準ライブラリのincludeなどが書かれたヘッダ・フッタをくっつけてビルドする仕組みとなっている。
これによりC/C++や組み込み開発特有の泥臭い処理を隠蔽している。

ホビー用ということもあってブレークポイントやレジスタ・メモリマップといった本格的なデバッグ機能は使用できず、`Serial.println()` 関数などを用いたいわゆる**printfデバッグ**で対処する (Visual Micro Arduino for Visual Studio (https://www.visualmicro.com/) を使用すると本格的なデバッグが可能)。

#### インストール

`https://www.arduino.cc/en/software` から最新版のArduino IDEをダウンロードする。
インストーラでは特に設定する項目もないので、実行してからは指示通りに進めていけば問題ない。
インストーラは英語だが、ソフトウェア自体は日本語表示に対応している。

インストール直後のArduino IDEにはESP32 Arduinoは入っていないので、こちらのインストールを進める。
まずは `ファイル` -> `環境設定` を開き、**追加のボードマネージャのURL**に `https://raw.githubusercontent.com/espressif/arduino-esp32/gh-pages/package_esp32_index.json` を入力して `OK` で閉じる。

続いて `ツール` -> `ボード` -> `ボードマネージャ` を開き、検索窓で `esp32` と検索してインストールする。
新規開発であれば2.0.xでほとんど問題ないが、過去のプログラムやライブラリを使用する場合は2.0.xでは動作せず、1.0.xを使わざるを得ないときもある。
なお複数バージョンの同居はできず、別のバージョンをインストールすると今まで使用していたバージョンは削除される。

- ESP32 Arduino 1.0.x: ESP-IDF 3.2/3.3
- ESP32 Arduino 2.0.x: ESP-IDF 4.4

#### 基本的な使い方

`ツール` -> `ボード` -> `ESP32 Arduino` からマイコンボードを選択する。
目的のボードが一覧に無いときは**ESP32 Dev Module**を選んでおくと素のESP32として開発できる。

予め作成済みの `setup()` (起動時に一度だけ実行) と `loop()` (`setup()` 以後繰り返し実行) 関数の中に処理を書いていく。
Arduino IDEのエディタは色が変わる程度の機能しかないので、あまり凝ったプログラムを書くには適していない。
サンプルコードは `ファイル` -> `スケッチ例` に収録されている。

コードファイルは、保存ダイアログで決めた名前で作成したフォルダの中に同名の `.ino` 形式で保存される (フォルダ名と同じでなければならない)。
C/C++の知識があるならincludeで読ませる前提のファイル分割も可能で、`.ino` のディレクトリ以下に `.h`、`.c`、`.cpp` などの形式で保存しておけばよい。

プログラムを書き込む時は `ツール` -> `シリアルポート` から接続先のシリアルポートを選択しておき、`スケッチ` -> `マイコンボードに書き込む` を実行すると、ビルドを実行して成功できればマイコンボードへ書き込まれる。
書き込みを行わず、ビルドだけする時は `スケッチ` -> `検証・コンパイル` を選ぶ。

シリアル通信で送受信するデータは `ツール` -> `シリアルモニタ` を開いて確認できる。
もちろん好みのシリアル通信モニタを用いても構わないが、プログラムの転送前には予め切断しておかないと書き込みに失敗する。

#### ライブラリ

ひとまとまりの機能を実現するプログラムは、モジュール単位にして**ライブラリ**として配布されている。
ソフトだけで完結する機能だけでなく、電子部品と通信して使うためのライブラリも作られている。

ライブラリを使うときは `スケッチ` -> `ライブラリをインクルード` から目的のライブラリを選ぶとincludeされる。

ライブラリのインストールや更新は `スケッチ` -> `ライブラリをインクルード` -> `ライブラリを管理` を開いて行う。
多数のライブラリをインストールしていると結構な頻度で更新が入るので、随時チェックされたし。

Arduinoは利用者が多く、著名な電子部品に対し何かしらのライブラリが出回っているのが大きな強みである。
一覧にライブラリがない部品でもGitHubなどを探すと見つかることも多い (ライセンスを確認して使用すること)。

### その他の開発環境

#### Espressif IoT Devalopment Framework

ESP32公式の開発環境で、全ての機能を使用できる。
C/C++で開発し (APIはC言語)、FreeRTOS上で動作する。

Pythonスクリプトをコマンドラインで実行して操作する開発環境だが、EclipseベースのIDEが用意されているほか、VSCode用の拡張機能もある。
FTDI FT232HをJTAGとして使用するとブレークポイントを張るデバッグにも対応する。

細かな動作ができる反面、ESP32 Arduinoと比べて格段に敷居が高い。
ドキュメントとサンプルコードが充実しているので、組み込み開発の知識がある、最新の機能をいち早く使用したい方は挑戦してほしい。

#### PlatformIO

Arduinoに似た環境で、最初から複数種類のマイコンとプラットフォームから選んで使用する前提で作られている。

VSCodeに拡張機能をインストールして使用する。
Arduino for VSCodeとは競合するので、インストールするのはどちらかにしておく。

#### UI Flow

M5Stack向けの開発環境。
ESP32をMicroPythonインタプリタとして動作させ、Wi-Fi経由でプログラムを転送する仕組み。
Webブラウザ上での開発が可能で、ブロックを組み立ててプログラムを設計するビジュアルプログラミングにも対応している。

筆者はArduinoで書けるので使用する機会がないのだが、Pythonが分かる方はこちらを使ってみるのも手。
